#!/bin/bash

#==============================================================================
# DESCRIPTION
#==============================================================================
# Purpose : This Script will be used to set-up Environment Variables for Job 
#==============================================================================
#                        MODIFICATIONS
#==============================================================================
# Date (YYYY-MM-DD)    Programmer Name     Change Description
# -----------------    -----------------   ------------------------------------
# 2016-06-12           Soumendra Mishra    Initial Creation
# 2016-07-19           Soumendra Mishra    Changed from File-Read to DB-Read
#==============================================================================

#==============================================================================
# Reading Table Properties
#==============================================================================

  #----------------------------------------------------------------------------
  # Table Info Schema & Data
  #----------------------------------------------------------------------------
  export TABLE_INFO_SCHEMA="ea_shared"
  export TABLE_INFO_OBJECT="wc_table_info"

  #----------------------------------------------------------------------------
  # Reading Table Info Data
  #----------------------------------------------------------------------------
  

  hive -S -e "SELECT * FROM ${TABLE_INFO_SCHEMA}.${TABLE_INFO_OBJECT} WHERE target_table='${TABLE_NAME}' and data_load_zone='RAW';" > "${JOB_HOME}/tmp/table_info_${TABLE_NAME}.txt" 2>&1

  chmod 777 ${JOB_HOME}/tmp/table_info_${TABLE_NAME}.txt

  export TABLE_INFO_FILE="${JOB_HOME}/tmp/table_info_${TABLE_NAME}.txt"

  #----------------------------------------------------------------------------
  # Validating table_info.txt file
  #----------------------------------------------------------------------------
  if [ ! -f "${TABLE_INFO_FILE}" ]
  then
      echo "[***Error***] Table info file not exists"
      exit 1
  fi

  L_TBL_INFO="`grep -w ${TABLE_NAME} ${TABLE_INFO_FILE}`"
    
  if [ -z "${L_TBL_INFO}" ]
  then
      echo "[***Error***] Table properties not found"
      exit 1
  fi

  #------------------------------------------------------------------------------  
  # Reading Table Properties
  #------------------------------------------------------------------------------
  export TBL_INFO_TABLE_INFO_ID="`echo ${L_TBL_INFO} | awk {'print $1'}`"
  export TBL_INFO_SOURCE_SYSTEM="`echo ${L_TBL_INFO} | awk {'print $2'}`"
  export TBL_INFO_DATA_LOAD_ZONE="`echo ${L_TBL_INFO} | awk {'print $3'}`"
  export TBL_INFO_DATA_LOAD_TYPE="`echo ${L_TBL_INFO} | awk {'print $4'}`"
  export TBL_INFO_SOURCE_SCHEMA="`echo ${L_TBL_INFO} | awk {'print $5'}`"
  export TBL_INFO_SOURCE_TABLE="`echo ${L_TBL_INFO} | awk {'print $6'}`"
  export TBL_INFO_TARGET_TABLE="`echo ${L_TBL_INFO} | awk {'print $7'}`"
  export TBL_INFO_PRIMARY_KEY="`echo ${L_TBL_INFO} | awk {'print $8'}`"
  export TBL_INFO_MIN_TS="`echo ${L_TBL_INFO} | awk {'print $9'}`"
  export TBL_INFO_MAX_TS="`echo ${L_TBL_INFO} | awk {'print $10'}`"
  export TBL_INFO_SQOOP_SPLIT_BY_FLAG="`echo ${L_TBL_INFO} | awk {'print $11'}`"
  export TBL_INFO_SQOOP_SPLIT_BY_COL="`echo ${L_TBL_INFO} | awk {'print $12'}`"
  export TBL_INFO_SQOOP_SPLIT_BY_LIMIT="`echo ${L_TBL_INFO} | awk {'print $12'}`"
  export TBL_INFO_INCR_TABLE_FLAG="`echo ${L_TBL_INFO} | awk {'print $14'}`"
  export TBL_INFO_MAP_COL_NULL="`echo ${L_TBL_INFO} | awk {'print $15'}`"

  #----------------------------------------------------------------------------
  # Check for Active Reporting/Incremental Table
  #----------------------------------------------------------------------------
  if [ "${TBL_INFO_INCR_TABLE_FLAG}" == "P" ]
  then
      export TBL_INFO_INCR_PRI_TABLE="${TBL_INFO_TARGET_TABLE}_pri"
      export TBL_INFO_INCR_SEC_TABLE="${TBL_INFO_TARGET_TABLE}_sec"
  else
      export TBL_INFO_INCR_PRI_TABLE="${TBL_INFO_TARGET_TABLE}_sec"
      export TBL_INFO_INCR_SEC_TABLE="${TBL_INFO_TARGET_TABLE}_pri"
  fi
